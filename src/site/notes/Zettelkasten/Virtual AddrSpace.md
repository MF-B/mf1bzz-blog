---
{"dg-publish":true,"permalink":"/zettelkasten/virtual-addr-space/"}
---

2025-05-03
Status: #idea
Tags: [[Zettelkasten/OS Camp Stage 3\|OS Camp Stage 3]]

# Virtual AddrSpace

## ArceOS用户地址空间
### 用户空间
初始化时将0-0x4000000000这段连续的虚拟地址放到其va_range里,此时只代表这段空间是属于本地址空间的,但里面没有实际内容.同时我们也新建一个空页表,为之后的地址映射做准备.

由于0-0x4000000000是一段很大的空间,而我们只需要用到其中的一部分地址,所以我们用MemorySet来维护我们用到的地址,其中MemorySet存放的是{起始虚拟地址, size}这样的数据结构(名为MemoryArea),这样我们就可以知道哪些虚拟地址会被使用了.

#### 映射
由于此时我们只是记录了哪些虚拟地址空间会被用到,但是还没有记录虚拟地址到物理地址的映射.
我们可以在建立MemoryArea的时候顺便进行虚拟地址到物理地址的映射
arceos有两种映射方法
##### Linear
需要手动提供物理地址
这种映射方法直接将虚拟地址映射到该物理地址
##### Alloc
此方法会先申请一个物理页帧,再将得到的物理地址与用户空间的虚拟地址做映射.
此方法也衍生出了懒加载:
- 在建立MemoryArea的时候不进行物理页帧的分配,而将虚拟地址全部映射到0地址.这样当用户程序访问到该段MemoryArea对应的虚拟地址时,会发生trap(与页相关的一些错误),这代表用户程序正在访问此虚拟地址.
- 我们将物理页帧分配这一步骤转移到trap处理程序中,当发生页错误trap时(主要是读写执行),我们再申请物理页帧,并修改页表映射.这样就完成了懒加载





___
# References
ArceOS ppt